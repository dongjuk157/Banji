## 소스 클론 이후 빌드 및 배포할 수 있는 작업문서

1. `git clone https://lab.ssafy.com/s05-iot-ctrl/S05P21B301.git`

2. 웹 환경 설치

   1. localhost: 테스트 용도

      **client:**

      - 소켓 통신 주소 변경
        - `client\src\main.js` 에서 socket 통신의 주소 변경
        - `const socket = io('http://localhost:12001/', { transports: ['websocket'] });`
      - 카카오 로그인 주소 변경
        - `client\src\components\LoginPage.vue`에서 redirect_uri 변경
        - `http://localhost:8080/oauth/callback/kakao`
      - `S05P21B301\ros2_smart_home\web\client\` 에서 `yarn install && yarn serve`
      - vue 환경 실행되면 완료

      **server:**

      - `S05P21B301\ros2_smart_home\web\server\` 에서 `npm install && node server.js`
      - `listening on *:12001` 출력되면 완료

   2. 배포 환경

      준비:

      ubuntu 20.04 LTS

      - 80, 443, 12001 포트 개방, 8080: jenkins

      docker 설치 https://docs.docker.com/engine/install/ubuntu/

      ssl 인증서

      1. 도커 이미지 빌드

         ```bash
         cd <저장되어있는 주소>/S05P21B301/ros2_smart_home/web/client/
         docker build -t vue-client .
         cd <저장되어있는 주소>/S05P21B301/ros2_smart_home/web/server/
         docker build -t node-server .
         ```

      2. 도커 이미지 실행

         ```bash
         # 이미 실행중인 컨테이너가 있으면 중지
         if (sudo docker ps | grep "vue-client"); then sudo docker stop vue-client; fi
         if (sudo docker ps | grep "node-server"); then sudo docker stop node-server; fi
         
         # 컨테이너 실행
         sudo docker network create b301net
         sudo docker run -it -d --rm -p 80:80 -p 443:443 --network b301net -v /home/ubuntu/certbot/conf:/etc/letsencrypt/ -v /home/ubuntu/certbot/www:/var/www/certbot --name vue-client vue-client
         sudo docker run -it -d --rm -p 12001:12001 --network b301net -v /home/ubuntu/certbot/conf:/etc/letsencrypt/ -v /home/ubuntu/certbot/www:/var/www/certbot  --name node-server node-server
         ```

   3. Jenkins CI/CD

      Freestyle Project 구성

      Gitlab 연결

      Execute shell

      ```bash
      docker image prune -a --force
      mkdir -p /var/jenkins_home/images_tar
      cd /var/jenkins_home/workspace/test2/client/
      docker build -t vue-client .
      docker save vue-client > /var/jenkins_home/images_tar/vue-client.tar
      
      cd /var/jenkins_home/workspace/test2/server/
      docker build -t node-server .
      docker save node-server > /var/jenkins_home/images_tar/node-server.tar
      
      ls /var/jenkins_home/images_tar
      ```

      Execute shell script on remote host using ssh: `J5B301T.pem` 사용

      ```bash
      ls /home/ubuntu/jenkins_home/images_tar
      
      sudo docker load < /home/ubuntu/jenkins_home/images_tar/vue-client.tar
      sudo docker load < /home/ubuntu/jenkins_home/images_tar/node-server.tar
      
      if (sudo docker ps | grep "vue-client"); then sudo docker stop vue-client; fi
      if (sudo docker ps | grep "node-server"); then sudo docker stop node-server; fi
      
      sudo docker run -it -d --rm -p 80:80 -p 443:443 --network b301net -v /home/ubuntu/certbot/conf:/etc/letsencrypt/ -v /home/ubuntu/certbot/www:/var/www/certbot --name vue-client vue-client
      echo "Run client"
      sudo docker run -it -d --rm -p 12001:12001 --network b301net -v /home/ubuntu/certbot/conf:/etc/letsencrypt/ -v /home/ubuntu/certbot/www:/var/www/certbot  --name node-server node-server
      echo "Run server"
      
      sudo docker ps
      ```

3. Robot 환경 설치

   1. git 저장소 내부의 ros2_smart_home을 ros 개발환경(catkin_ws)으로 복사

      `S05P21B301\ros2_smart_home\`

      `C:\Users\<username>\Desktop\catkin_ws\src\ros2_smart_home\`

   2. [`localhost`](http://localhost) 에서 테스트하는 경우

      `ros2_smart_home\sub2\sub2\human_detector.py`

      `ros2_smart_home\sub3\sub3\ros_iot_connect.py`

      위의 두 파일에서 `sio.connect('http://j5b301.p.ssafy.io:12001/')` 를 `sio.connect('http://localhost:12001')` 로 교체

   3. ros 패키지 빌드

      ```jsx
      call C:\dev\ros2_eloquent\setup.bat
      cd C:\Users\multicampus\Desktop\catkin_ws
      colcon build
      ```

   4. 각각의 터미널로 실행

      1. ssafybridege_launch: 시뮬레이터와 로컬 환경 통신

         ```jsx
         call C:\dev\ros2_eloquent\setup.bat
         call C:\Users\multicampus\Desktop\catkin_ws\install\local_setup.bat
         cd C:\Users\multicampus\Desktop\catkin_ws\src\ros2_smart_home\ssafy_bridge\launch
         ros2 launch ssafybridge_launch.py
         ```

      2. sub2 launch

         ```jsx
         call C:\dev\ros2_eloquent\setup.bat
         call C:\Users\multicampus\Desktop\catkin_ws\install\local_setup.bat
         cd C:\Users\multicampus\Desktop\catkin_ws\src\ros2_smart_home\sub2\launch
         ros2 launch sub2.py
         ```

      3. sub3 client

         ```jsx
         call C:\dev\ros2_eloquent\setup.bat
         call C:\Users\\multicampus\Desktop\catkin_ws\install\local_setup.bat
         cd C:\Users\multicampus\Desktop\catkin_ws
         ros2 run sub3 aws_client
         // localhost 인경우 ros2 run sub3 client
         ```

4. 배포환경에서 진행하는 경우 브라우저(ex 크롬) - 사이트 설정 - 안전하지 않은 콘텐츠 허용 설정

   1. socket.io가 ssl이 적용이 되어있지 않아서 mixed-content 에러로 막힘